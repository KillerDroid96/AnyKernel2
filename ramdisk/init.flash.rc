# Flash Kernel initialization script
# Pieces taken from @anarkia1976, @franciscofranco, @frap129, and @flar2

on post-fs
   write /dev/cpuset/foreground/cpus 0-7
   write /dev/cpuset/foreground/boost/cpus 0-7
   write /dev/cpuset/background/cpus 0-7
   write /dev/cpuset/system-background/cpus 0-7

on property:sys.boot_completed=1
   # according to Qcom this legacy value improves first launch latencies
   # stock value is 512k
   # from franciscofranco
   setprop dalvik.vm.heapminfree 2m

   # cpuset
   write /dev/cpuset/foreground/cpus 0-2,4-7
   write /dev/cpuset/foreground/boost/cpus 4-7
   write /dev/cpuset/background/cpus 0-2
   write /dev/cpuset/system-background/cpus 0-2

   # I/O scheduler - zen - 512kb
   write /sys/block/mmcblk0/queue/scheduler zen
   write /sys/block/mmcblk0/queue/read_ahead_kb 512

   # Make sure governor sys paths have the correct permissions
   chown system system /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
   chmod 0664 /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
   chown system system /sys/devices/system/cpu/cpu4/cpufreq/scaling_governor
   chmod 0664 /sys/devices/system/cpu/cpu4/cpufreq/scaling_governor

   # Little cluster min - 384 MHz
   chown system system /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq
   chmod 0664 /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq
   write /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq 384000
   chmod 0444 /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq
   # Little cluster max - 1555 MHz
   chown system system /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq
   chmod 0664 /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq
   write /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq 1555200
   chmod 0444 /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq
   # Big cluster min - 633 MHz
   chown system system /sys/devices/system/cpu/cpu4/cpufreq/scaling_min_freq
   chmod 0664 /sys/devices/system/cpu/cpu4/cpufreq/scaling_min_freq
   write /sys/devices/system/cpu/cpu4/cpufreq/scaling_min_freq 633600
   chmod 0444 /sys/devices/system/cpu/cpu4/cpufreq/scaling_min_freq
   # Big cluster max - 1958 MHz
   chown system system /sys/devices/system/cpu/cpu4/cpufreq/scaling_max_freq
   chmod 0664 /sys/devices/system/cpu/cpu4/cpufreq/scaling_max_freq
   write /sys/devices/system/cpu/cpu4/cpufreq/scaling_max_freq 1958400
   chmod 0444 /sys/devices/system/cpu/cpu4/cpufreq/scaling_max_freq

   # Governor settings by me: Flash 1.1
   # Little cluster settings
   write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor flash
   write /sys/devices/system/cpu/cpu0/cpufreq/flash/go_hispeed_load 99
   write /sys/devices/system/cpu/cpu0/cpufreq/flash/above_hispeed_delay "20000 1344000:40000"
   write /sys/devices/system/cpu/cpu0/cpufreq/flash/timer_rate 30000
   write /sys/devices/system/cpu/cpu0/cpufreq/flash/hispeed_freq 768000
   write /sys/devices/system/cpu/cpu0/cpufreq/flash/timer_slack -1
   write /sys/devices/system/cpu/cpu0/cpufreq/flash/target_loads "60 384000:50 460800:50 600000:55 672000:60 768000:60 864000:60 960000:85 1248000:90 1344000:80 1478000:90 1555200:95"
   write /sys/devices/system/cpu/cpu0/cpufreq/flash/min_sample_time 60000
   write /sys/devices/system/cpu/cpu0/cpufreq/flash/ignore_hispeed_on_notif 0
   write /sys/devices/system/cpu/cpu0/cpufreq/flash/fast_ramp_down 0
   write /sys/devices/system/cpu/cpu0/cpufreq/flash/align_windows 0
   write /sys/devices/system/cpu/cpu0/cpufreq/flash/use_migration_notif 0
   write /sys/devices/system/cpu/cpu0/cpufreq/flash/use_sched_load 0
   write /sys/devices/system/cpu/cpu0/cpufreq/flash/max_freq_hysteresis 80000

   # Big cluster settings
   write /sys/devices/system/cpu/cpu4/cpufreq/scaling_governor flash
   write /sys/devices/system/cpu/cpu4/cpufreq/flash/go_hispeed_load 95
   write /sys/devices/system/cpu/cpu4/cpufreq/flash/above_hispeed_delay "40000 960000:60000 1728000:20000"
   write /sys/devices/system/cpu/cpu4/cpufreq/flash/timer_rate 30000
   write /sys/devices/system/cpu/cpu4/cpufreq/flash/hispeed_freq 633600
   write /sys/devices/system/cpu/cpu4/cpufreq/flash/timer_slack -1
   write /sys/devices/system/cpu/cpu4/cpufreq/flash/target_loads "95 633600:75 768000:85 864000:85 960000:88 1248000:95 1344000:95 1444000:95 1536000:95 1632000:95 1728000:98 1824000:99 1958000:100"
   write /sys/devices/system/cpu/cpu4/cpufreq/flash/min_sample_time 30000
   write /sys/devices/system/cpu/cpu4/cpufreq/flash/ignore_hispeed_on_notif 0
   write /sys/devices/system/cpu/cpu4/cpufreq/flash/fast_ramp_down 0
   write /sys/devices/system/cpu/cpu4/cpufreq/flash/align_windows 0
   write /sys/devices/system/cpu/cpu4/cpufreq/flash/use_migration_notif 0
   write /sys/devices/system/cpu/cpu4/cpufreq/flash/use_sched_load 0
   write /sys/devices/system/cpu/cpu4/cpufreq/flash/max_freq_hysteresis 80000

   # Input boost configuration
   write /sys/module/cpu_boost/parameters/input_boost_enabled 1
   write /sys/module/cpu_boost/parameters/input_boost_freq "0:1248000 1:1248000 2:1248000 3:1248000 4:0 5:0 6:0 7:0"
   write /sys/module/cpu_boost/parameters/input_boost_ms 60

   # Lazyplug
   write /sys/module/lazyplug/parameters/lazyplug_active 1

   # Backlight dimmer
   write /sys/module/mdss_fb/parameters/backlight_dimmer 1

   # UKSM
   write /sys/kernel/mm/uksm/run 1

   # Wakelock dividers
   write /sys/module/bcmdhd/parameters/wlrx_divide 8
   write /sys/module/bcmdhd/parameters/wlctrl_divide 8

   # re-enable retention idle state
   # fix-up is merged in the Kernel
   write /sys/module/lpm_levels/system/a53/cpu0/retention/idle_enabled 1
   write /sys/module/lpm_levels/system/a53/cpu1/retention/idle_enabled 1
   write /sys/module/lpm_levels/system/a53/cpu2/retention/idle_enabled 1
   write /sys/module/lpm_levels/system/a53/cpu3/retention/idle_enabled 1
   write /sys/module/lpm_levels/system/a57/cpu4/retention/idle_enabled 1
   write /sys/module/lpm_levels/system/a57/cpu5/retention/idle_enabled 1
   write /sys/module/lpm_levels/system/a57/cpu6/retention/idle_enabled 1
   write /sys/module/lpm_levels/system/a57/cpu7/retention/idle_enabled 1
   write /sys/module/lpm_levels/system/a53/a53-l2-retention/idle_enabled 1
   write /sys/module/lpm_levels/system/a57/a57-l2-retention/idle_enabled 1

   # bcmdhd wakeup sources
   write /sys/module/wakeup/parameters/enable_wlan_rx_wake_ws 0
   write /sys/module/wakeup/parameters/enable_wlan_ctrl_wake_ws 0
   write /sys/module/wakeup/parameters/enable_wlan_wake_ws 0
   write /sys/module/wakeup/parameters/enable_ipa_ws 0

   # Special power script - executes three times under different SELinux contexts
   exec u:r:init:s0 root root -- /init.special_power.sh
   exec u:r:su:s0 root root -- /init.special_power.sh
   exec u:r:supersu:s0 root root -- /init.special_power.sh
